<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Convertisseur Vid√©o en MP3</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      input[type="text"],
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }

      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-download {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-download:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-clear {
        background: #f0f0f0;
        color: #666;
      }

      .btn-clear:hover {
        background: #e0e0e0;
      }

      .downloads-list {
        margin-top: 40px;
        padding-top: 40px;
        border-top: 2px solid #f0f0f0;
      }

      .downloads-title {
        color: #333;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .download-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
      }

      .download-title {
        color: #333;
        font-weight: 500;
        margin-bottom: 8px;
        word-break: break-word;
      }

      .download-progress {
        margin-bottom: 10px;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s;
      }

      .download-info {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
      }

      .download-status {
        font-size: 13px;
        color: #667eea;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .status-error {
        color: #e74c3c;
      }

      .status-success {
        color: #27ae60;
      }

      .btn-download-file {
        width: 100%;
        padding: 8px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        margin-top: 10px;
        transition: background 0.3s;
      }

      .btn-download-file:hover {
        background: #229954;
      }

      .empty-state {
        text-align: center;
        color: #999;
        font-size: 13px;
        padding: 20px;
      }

      .alert {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 13px;
      }

      .alert-error {
        background: #fadbd8;
        color: #c0392b;
        border: 1px solid #e74c3c;
      }

      .alert-success {
        background: #d5f4e6;
        color: #27ae60;
        border: 1px solid #27ae60;
      }

      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 22px;
        }

        .button-group {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéµ Convertisseur Vid√©o en MP3</h1>
      <p class="subtitle">
        T√©l√©chargez et convertissez vos vid√©os en audio MP3
      </p>

      <div id="alert"></div>

      <div class="input-group">
        <label for="videoUrl">Lien vid√©o (YouTube, etc.)</label>
        <input
          type="text"
          id="videoUrl"
          placeholder="Collez l'URL de votre vid√©o ici..."
        />
      </div>

      <div class="input-group">
        <label for="format">Format audio</label>
        <select id="format">
          <option value="mp3">MP3 (Universal)</option>
          <option value="wav">WAV (Sans compression)</option>
          <option value="m4a">M4A (iTunes)</option>
          <option value="flac">FLAC (Haute qualit√©)</option>
          <option value="opus">Opus (Web)</option>
          <option value="vorbis">OGG Vorbis (Ouvert)</option>
        </select>
      </div>

      <div class="input-group">
        <label for="quality">Qualit√© audio</label>
        <select id="quality">
          <option value="128">128 kbps (Faible)</option>
          <option value="192" selected>192 kbps (Normal)</option>
          <option value="256">256 kbps (Meilleure)</option>
          <option value="320">320 kbps (Haute)</option>
        </select>
      </div>

      <div class="button-group">
        <button class="btn-download" id="downloadBtn">T√©l√©charger</button>
        <button class="btn-clear" id="clearBtn">Effacer</button>
      </div>

      <div class="downloads-list">
        <div class="downloads-title">T√©l√©chargements</div>
        <div id="downloadsList"></div>
      </div>
    </div>

    <script>
      const videoUrlInput = document.getElementById("videoUrl");
      const formatSelect = document.getElementById("format");
      const qualitySelect = document.getElementById("quality");
      const downloadBtn = document.getElementById("downloadBtn");
      const clearBtn = document.getElementById("clearBtn");
      const downloadsList = document.getElementById("downloadsList");
      const alertDiv = document.getElementById("alert");

      let activeDownloads = new Map();

      downloadBtn.addEventListener("click", startDownload);
      clearBtn.addEventListener("click", clearForm);

      function showAlert(message, type) {
        alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        if (type === "success") {
          setTimeout(() => (alertDiv.innerHTML = ""), 5000);
        }
      }

      function clearForm() {
        videoUrlInput.value = "";
        videoUrlInput.focus();
      }

      function startDownload() {
        const url = videoUrlInput.value.trim();
        const format = formatSelect.value;
        const quality = qualitySelect.value;

        if (!url) {
          showAlert("Veuillez entrer une URL valide", "error");
          return;
        }

        downloadBtn.disabled = true;

        fetch("/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url: url,
            format: format,
            quality: quality,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              showAlert(data.error, "error");
              downloadBtn.disabled = false;
              return;
            }

            const downloadId = data.download_id;
            activeDownloads.set(downloadId, true);
            monitorDownload(downloadId);
            videoUrlInput.value = "";
            downloadBtn.disabled = false;
          })
          .catch((err) => {
            showAlert("Erreur: " + err.message, "error");
            downloadBtn.disabled = false;
          });
      }

      function monitorDownload(downloadId) {
        const checkInterval = setInterval(() => {
          fetch(`/status/${downloadId}`)
            .then((res) => res.json())
            .then((data) => {
              updateDownloadUI(downloadId, data);

              if (data.status === "completed" || data.status === "error") {
                clearInterval(checkInterval);
                activeDownloads.delete(downloadId);
                if (data.status === "completed") {
                  showAlert(
                    `‚úì ${data.title} t√©l√©charg√© avec succ√®s`,
                    "success"
                  );
                }
              }
            })
            .catch((err) => console.error("Erreur de statut:", err));
        }, 500);
      }

      function updateDownloadUI(downloadId, data) {
        let item = document.getElementById(`download-${downloadId}`);

        if (!item) {
          item = document.createElement("div");
          item.id = `download-${downloadId}`;
          item.className = "download-item";
          downloadsList.insertBefore(item, downloadsList.firstChild);
        }

        let html = "";

        if (data.status === "downloading") {
          html = `
                    <div class="download-title">${
                      data.title || "T√©l√©chargement en cours..."
                    }</div>
                    <div class="download-info">
                        <span>Vitesse: ${data.speed || "-"}</span>
                        <span>ETA: ${data.eta || "-"}</span>
                    </div>
                    <div class="download-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${
                              parseFloat(data.percent) || 0
                            }%"></div>
                        </div>
                    </div>
                    <div class="download-info">
                        <span>Progression: ${data.percent || "0%"}</span>
                    </div>
                `;
        } else if (data.status === "processing") {
          html = `
                    <div class="download-title">${
                      data.title || "Traitement..."
                    }</div>
                    <div class="download-status">‚è≥ ${data.message}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%; animation: pulse 1.5s infinite;"></div>
                    </div>
                `;
        } else if (data.status === "completed") {
          html = `
                    <div class="download-title">${data.title}</div>
                    <div class="download-status status-success">‚úì T√©l√©chargement termin√©</div>
                    <button class="btn-download-file" onclick="downloadFile('${data.filename}')">
                        T√©l√©charger le fichier
                    </button>
                `;
        } else if (data.status === "error") {
          html = `
                    <div class="download-title">Erreur</div>
                    <div class="download-status status-error">‚úó ${data.error}</div>
                `;
        } else if (data.status === "starting" || data.status === "queued") {
          html = `
                    <div class="download-status">‚è≥ ${
                      data.message || "Mise en file d'attente..."
                    }</div>
                `;
        }

        item.innerHTML = html;
      }

      function downloadFile(filename) {
        const link = document.createElement("a");
        link.href = `/file/${filename}`;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Ajouter du CSS pour l'animation de pulsation
      const style = document.createElement("style");
      style.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
        `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
